<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">QueryHelper/QueryHelper.format.js | sails-hook-sequelize-querier</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Hook to add powerful customize sequelize querier for sails application"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="sails-hook-sequelize-querier"><meta property="twitter:description" content="Hook to add powerful customize sequelize querier for sails application"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/iamcxa/sails-hook-querier"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-destroy">destroy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatFieldQueryWithOrCondition">formatFieldQueryWithOrCondition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatInput">formatInput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatOutput">formatOutput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-matchFormat">matchFormat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDetail">getDetail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildEmptyModel">buildEmptyModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAssociations">getAssociations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEnumValues">getEnumValues</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getIncludeModelByObject">getIncludeModelByObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getIncludeModelColumns">getIncludeModelColumns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getModelByName">getModelByName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getModelColumnType">getModelColumnType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getModelColumns">getModelColumns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getModelOutputColumns">getModelOutputColumns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getModelSearchableColumns">getModelSearchableColumns</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isCommonField">isCommonField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isNumeric">isNumeric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-modelAssociationsToArray">modelAssociationsToArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validate">validate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-update">update</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-findBy">findBy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatQuery">formatQuery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDetailPageFieldWithAssociations">getDetailPageFieldWithAssociations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getIndexPageTableAndFilters">getIndexPageTableAndFilters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TAG">TAG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-commonFields">commonFields</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isDate">isDate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-langCode">langCode</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">QueryHelper/QueryHelper.format.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import _ from &apos;lodash&apos;;

/**
 * &#x4F9D;&#x64DA;&#x8F38;&#x5165;&#x7684; format &#x7269;&#x4EF6;&#x4F86;&#x683C;&#x5F0F;&#x5316;&#x8F38;&#x51FA;&#xFF0C;&#x5C07; data &#x8207; format &#x5408;&#x4F75;&#x4E26;&#x4FDD;&#x7559; format &#x4F5C;&#x70BA;&#x9810;&#x8A2D;&#x503C;&#x3002;
 * @version 20180310
 * @example
 * QueryHelper.matchFormat({
 *    format: {
 *      updatedAt: &apos;&apos;,
 *      createdAt: &apos;&apos;,
 *      id: &apos;&apos;,
 *      type: &apos;&apos;,
 *      title: {
 *        &apos;zh-TW&apos;: &apos;&apos;,
 *        en: &apos;&apos;,
 *      },
 *    },
 *    data,
 * });
 * // {
 * //  updatedAt: &apos;03/29/2018&apos;,
 * //  createdAt: &apos;03/29/2018&apos;,
 * //  id: 5,
 * //  type: &apos;ceu&apos;,
 * //  title: {
 * //    &apos;zh-TW&apos;: &apos;&#x6E2C;&#x8A66;&#x6E2C;&#x8A66;&#x6E2C;&#x8A66;&#x6E2C;&#x8A66;&apos;,
 * //    en: &apos;Test Test Test&apos;
 * //  },
 * // }
 * @param Required {Object} {
 *     format{Object} = null,  &#x9810;&#x5148;&#x5B9A;&#x7FA9;&#x7684;&#x8CC7;&#x6599;&#x683C;&#x5F0F;&#x3002;
 *     data{Object} = null,    &#x5C1A;&#x672A;&#x8655;&#x7406;&#x904E;&#x7684;&#x8F38;&#x5165;&#x8CC7;&#x6599;&#x3002;
 *   }
 * @returns formated data
 * @see {@link https://lodash.com/docs/4.17.5#findKey}
 * @see {@link https://lodash.com/docs/4.17.5#hasIn}
 * @see {@link https://lodash.com/docs/4.17.5#has}
 */
export function matchFormat({ format = null, data = null }) {
  try {
    const body = { ...format };
    for (const prop in format) {
      if (typeof data[prop] !== &apos;undefined&apos; &amp;&amp; data[prop] !== null) {
        if (_.has(data, prop)) {
          body[prop] = data[prop];
        } else if (_.hasIn(data, prop)) {
          body[prop] = data[_.findKey(data, prop)][prop];
        }
      }
    }
    return body;
  } catch (e) {
    sails.log.error(e);
    throw e;
  }
}

/**
 * &#x4F9D;&#x64DA;&#x5B9A;&#x7FA9;&#x597D;&#x7684;&#x6B04;&#x4F4D;&#x6BD4;&#x5C0D;&#x4E26;&#x540C;&#x6B65;&#x8F38;&#x5165;&#x8207;&#x76EE;&#x6A19;&#x7269;&#x4EF6;&#x3002;
 * @version 1.0
 * @param Required {Object} {
 *     modelName{String} = null,  &#x76EE;&#x6A19; Sequelize Model &#x540D;&#x7A31;&#x3002;
 *     format{Object} = null,     &#x9810;&#x5148;&#x5B9A;&#x7FA9;&#x7684;&#x8CC7;&#x6599;&#x683C;&#x5F0F;&#x3002;
 *     formatCb{Function} = null, &#x6700;&#x5F8C;&#x8F38;&#x51FA;&#x524D;&#x518D;&#x6B21;&#x683C;&#x5F0F;&#x5316;&#x8CC7;&#x6599;&#x7684; callback&#x3002;
 *     rawData{Object} = null,    &#x5C1A;&#x672A;&#x8655;&#x7406;&#x904E;&#x7684;&#x8F38;&#x5165;&#x8CC7;&#x6599;&#x3002;
 *     source{Object} = null,     &#x8981;&#x88AB;&#x586B;&#x5165;&#x7684;&#x7A7A;&#x767D;&#x8CC7;&#x6599;&#x6B04;&#x4F4D;&#x3002;
 *   }
 * @example
 * QueryHelper.formatInput({
 *    modelName,
 *    format,
 *    formatCb,
 *    source: QueryHelper.buildEmptyModel({
 *       modelName,
 *    }),
 *    rawData: input,
 * });
 * @returns {Object} &#x683C;&#x5F0F;&#x5316;&#x904E;&#x7684;&#x8F38;&#x5165;&#x8CC7;&#x6599;&#x3002;
 * @see {@link https://lodash.com/docs/4.17.5#hasIn}
 * @see {@link https://lodash.com/docs/4.17.5#has}
 * @see {@link https://lodash.com/docs/4.17.5#set}
 */
export function formatInput({
  // eslint-disable-next-line no-unused-vars
  modelName = null,
  format = null,
  source = null,
  rawData = null,
  formatCb = null,
}) {
  try {
    // &#x6BD4;&#x5C0D;&#x4F86;&#x6E90;&#x8207;&#x76EE;&#x7684;&#x7269;&#x4EF6;&#x662F;&#x5426;&#x6709;&#x4EE5;&#x4E0B;&#x6B04;&#x4F4D;
    if (format) {
      for (const path of format) {
        // Console.log(&apos;path=&gt;&apos;, path);
        if (_.hasIn(rawData, path)) {
          // Console.log(&apos;_.get(rawData, path)=&gt;&apos;, _.get(rawData, path));
          const value = _.get(rawData, path);
          if (
            _.isNil(value)
            || (!this.isNumeric(value)
              &amp;&amp; _.isEmpty(value)
              &amp;&amp; !_.isBoolean(value)
              &amp;&amp; !_.isFunction(value))
          ) {
            _.set(source, path, null);
          } else if (_.isString(value) &amp;&amp; value.match(this.isDate) !== null) {
            // &#x6AA2;&#x67E5;&#x8F38;&#x5165;&#x662F;&#x5426;&#x5305;&#x542B;&#x65E5;&#x671F;
            try {
              const valueAsDate = new Date(value);
              _.set(source, path, valueAsDate);
            } catch (e) {
              sails.log.warn(
                `[!] ${this.TAG}.formatInput: Parse Value &quot;${value}&quot; into Date type failed(${e}). this may not be an issue, will fallback to it origin String type value.`,
              );
              _.set(source, path, value);
            }
          } else if (value === &apos;Invalid date&apos;) {
            _.set(source, path, null);
          } else {
            _.set(source, path, value);
          }
        }
      }
    }
    const hasCb = !_.isNil(formatCb) &amp;&amp; _.isFunction(formatCb);
    return hasCb ? formatCb(source) : source;
  } catch (e) {
    sails.log.error(e);
    throw e;
  }
}

/**
 * &#x683C;&#x5F0F;&#x5316;&#x4F86;&#x81EA; Sequelize Query &#x7684;&#x8F38;&#x51FA;&#x7269;&#x4EF6;&#xFF0C;&#x4E26;&#x8996;&#x8F38;&#x5165;&#x4F86;&#x8F38;&#x51FA;&#x8A72; Model &#x7684;&#x6B04;&#x4F4D;&#x5B9A;&#x7FA9;&#x7D66;&#x524D;&#x7AEF;&#x3002;
 * &#x5982;&#x679C;&#x6709;&#x7D66;&#x4E88; fields&#xFF0C;&#x53EF;&#x4EE5;&#x4F9D;&#x64DA; required &#x8207; readonly &#x53C3;&#x6578;&#xFF0C;&#x7D66;&#x4E88;&#x524D;&#x7AEF;&#x53EF;&#x4EE5;&#x81EA;&#x52D5;&#x7522;&#x751F;&#x8868;&#x683C;&#x7684;&#x8CC7;&#x6599;&#x3002;
 * @version 1.0
 * @param Required {Object} {
 *     format{Object} = null,     &#x9810;&#x5148;&#x5B9A;&#x7FA9;&#x7684;&#x8CC7;&#x6599;&#x683C;&#x5F0F;&#x3002;
 *     formatCb{Function} = null, &#x6700;&#x5F8C;&#x8F38;&#x51FA;&#x524D;&#x518D;&#x6B21;&#x683C;&#x5F0F;&#x5316;&#x8CC7;&#x6599;&#x7684; callback&#x3002;
 *     data{Object} = null,       &#x4F86;&#x81EA; Sequelize Query &#x5F8C;&#x7684;&#x539F;&#x59CB;&#x7684;&#x8F38;&#x51FA;&#x8CC7;&#x6599;&#x3002;
 *     fields{Object} = null,     &#x9810;&#x5148;&#x5B9A;&#x7FA9;&#x7684; Sequelize Model &#x6B04;&#x4F4D;&#x5B9A;&#x7FA9;&#x3002;
 *     required{Array} = [],     &#x8981;&#x88AB;&#x8A2D;&#x5B9A;&#x70BA; required &#x7684;&#x6B04;&#x4F4D;&#x540D;&#x7A31;&#x3002;
 *     readonly{Array} = [],     &#x8981;&#x88AB;&#x8A2D;&#x5B9A;&#x70BA; readonly &#x7684;&#x6B04;&#x4F4D;&#x540D;&#x7A31;&#x3002;
 *  }
 * @example
 * QueryHelper.formatOutput({
 *    format,
 *    formatCb,
 *    fields,
 *    required,
 *    readonly,
 *    data: data.toJSON(),
 *  });
 * @returns {Object} &#x683C;&#x5F0F;&#x5316;&#x904E;&#x7684;&#x8F38;&#x51FA;&#x8CC7;&#x6599;&#x8207; Sequelize Model &#x6B04;&#x4F4D;&#x5B9A;&#x7FA9;&#x3002;
 */
export function formatOutput({
  format = null,
  formatCb = null,
  data = null,
  fields = null,
  required = [],
  readonly = [],
  extra = null,
  view = false,
}) {
  let result = {};
  try {
    // &#x683C;&#x5F0F;&#x5316;&#x8F38;&#x51FA;
    if (format) {
      // &#x6BD4;&#x5C0D;&#x4F86;&#x6E90;&#x8207;&#x76EE;&#x7684;&#x7269;&#x4EF6;&#x662F;&#x5426;&#x6709;&#x4EE5;&#x4E0B;&#x6B04;&#x4F4D;
      for (const path of format) {
        if (_.hasIn(data, path)) {
          const value = _.get(data, path);
          if (_.isEmpty(value)) {
            _.set(result, path, null);
            // &#x6AA2;&#x67E5;&#x8F38;&#x5165;&#x662F;&#x5426;&#x5305;&#x542B;&#x65E5;&#x671F;
          } else if (value.match(this.isDate) !== null) {
            _.set(result, path, new Date(value));
          } else {
            _.set(result, path, value);
          }
        }
      }
    } else {
      result = data;
    }
    // &#x6AA2;&#x67E5;&#x4E26;&#x8F38;&#x51FA;&#x524D;&#x7AEF;&#x8981;&#x986F;&#x793A;&#x7684;&#x6B04;&#x4F4D;&#x8207;&#x985E;&#x578B;
    if (view &amp;&amp; fields) {
      result._fields = fields.map((field) =&gt; {
        // &#x5982;&#x679C;&#x5DF2;&#x7D93;&#x6709; required &#x8207; readonly &#x6B04;&#x4F4D;&#x5247;&#x4E0D;&#x4FEE;&#x6539;
        if (_.has(field, &apos;required&apos;) &amp;&amp; _.has(field, &apos;readonly&apos;)) {
          return field;
        }
        return {
          ...field,
          required: required ? required.some((r) =&gt; r === field) : false,
          readonly: readonly ? readonly.some((r) =&gt; r === field) : false,
        };
      });
    }
    if (extra) {
      result = {
        ...result,
        ...extra,
      };
    }
    return !_.isNil(formatCb) &amp;&amp; _.isFunction(formatCb)
      ? formatCb(result)
      : result;
  } catch (e) {
    sails.log.error(e);
    throw e;
  }
}

/**
 * &#x66FF; fields &#x52A0;&#x5165; or &#x689D;&#x4EF6;
 * @param {*} fields
 * @returns
 */
export function formatFieldQueryWithOrCondition(fields) {
  try {
    const fieldsOr = [];
    const fieldsOrCommand = [];
    fields.forEach((e) =&gt; {
      if (!fieldsOr.find((x) =&gt; x === e.key)) {
        fieldsOr.push(e.key);
        fieldsOrCommand.push({
          $or: [
            {
              key: e.key,
              value: e.value,
            },
          ],
        });
      } else {
        const i = fieldsOr.findIndex((x) =&gt; x === e.key);
        fieldsOrCommand[i].$or.push({
          key: e.key,
          value: e.value,
        });
      }
    });
    return fieldsOrCommand;
  } catch (e) {
    sails.log.error(e);
    throw e;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
